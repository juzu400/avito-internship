# avito-internship

Уважаемая команда Авито!
Спасибо за возможность поучаствовать в отборе на стажировку, ниже представлено описание моего решения тестового задания.

## Стек

- Язык: **Go (Golang)**
- База данных: **PostgreSQL**
- Все поднимается в **Docker**
- HTTP-слой: **chi**
- Работа с БД: **pgx**
- Логирование: **slog**
- Тестирование: стандартный `testing`, `httptest`, моки через `gomock`.
- Линтер: **golangci-lint**

## Запуск

В проекте используется `Makefile` для упрощения команд.
- Запуск всего стека (Postgres + сервис): `make docker-up`
- Остановка и очистка данных: `make docker-down`
- Локальный запуск сервиса: `make run`
- Сборка бинарника: `make build`
- Тесты: `make test`
- Запуск линтера: `make lint`
- Обновить зависимости: `make tidy`

По умолчанию сервис слушает `:8080`.

## Реализовано

- Реализованы все требования основного задания:
    - команды: создание, получение по названию;
    - пользователи: изменение статуса активности, получение списка PR, где пользователь ревьюер;
    - pull request’ы: создание с автоподбором ревьюеров, merge (идемпотентный), переназначение ревьюера.
- Добавлен логгер для бизнес-событий и ошибок.
- Настроены миграции БД: при запуске приложения автоматически выполняются все `.sql`-миграции из каталога `migrations/`, отдельные команды для этого не требуются.
- Написаны юнит-тесты для сервисов и HTTP-хэндлеров с использованием `gomock` и `httptest`.
- Из доп. требований:
    - настроен и вынесен в `Makefile` запуск линтера (`golangci-lint run ./...`).

## Коротко про поведение и ошибки

Все ошибки возвращаются в едином формате:
```json
{
  "error": {
    "code": "КОД_ОШИБКИ",
    "message": "описание"
  }
}
```
Основные коды ошибок:  
`VALIDATION_ERROR`, `NOT_FOUND`, `TEAM_EXISTS`, `PR_EXISTS`, `PR_MERGED`, `NOT_ASSIGNED`, `NO_CANDIDATE`, `INTERNAL_ERROR`.

Кратко по эндпоинтам:

**POST `/team/add`** — создаёт команду.  
Ответы:  
- `201` — успех, созданная команда; 
- `400` — невалидный JSON / ошибка валидации (`team_name` пустой, пустой `user_id`, дубликат участника, пользователь уже находится в другой команде, команда уже существует);
- `500` — внутренняя ошибка.

**GET `/team/get`** — получить команду по названию.
Параметры передаются через **query**: `?team_name=`. 
Ответы:  
- `200` — успех, полученная команда;  
- `400` — нет `team_name` или ошибка валидации;  
- `404` — `NOT_FOUND`;  
- `500` — внутренняя ошибка.

**POST `/users/setIsActive`** — изменение статуса активности пользователя.  
Ответы:  
- `200` — успех, обновлённый пользователь;  
- `400` — невалидный JSON / пустой `user_id`;  
- `404` — `NOT_FOUND`;  
- `500` — внутренняя ошибка.

**GET `/users/getReview`** — список PR, где пользователь выступает ревьюером.  
Параметры передаются через **query**: `?user_id=`.
Ответы:  
- `200` — успех, список PR;  
- `400` — нет `user_id` / ошибка валидации;  
- `404` — пользователь не найден;  
- `500` — внутренняя ошибка.

**POST `/pullRequest/create`** — создать PR.  
Логика: создаёт PR, находит команду автора и выбирает до двух активных ревьюеров из команды (кроме автора).  
Ответы:  
- `201` — успех, созданный PR;  
- `400` — невалидный JSON / пустые поля (`pull_request_id`, `pull_request_name`, `author_id`);  
- `404` — автор не найден;  
- `409` — `PR_EXISTS`;  
- `500` — внутренняя ошибка.

**POST `/pullRequest/merge`** — merge PR (идемпотентно).  
Ответы:  
- `200` — успех, PR с обновленным статусом или PR, который уже был в статусе `MERGED`;  
- `400` — невалидный JSON / пустой `pull_request_id`;  
- `404` — PR не найден;  
- `500` — внутренняя ошибка.

**POST `/pullRequest/reassign`** — переназначение ревьюера.   
Ответы:  
- `200` — успех, ревьювер успешно переназначен;  
- `400` — невалидный JSON / ошибочные параметры;  
- `404` — PR или пользователь не найдены;  
- `409` — конфликт: `PR_MERGED` (PR уже смержен), `NOT_ASSIGNED` (старый ревьювер не был назначен на этот PR), `NO_CANDIDATE` (нет кандидатов на замену);  
- `500` — внутренняя ошибка.

---

## Принятые решения и допущения

- **Порт в OpenAPI** — в `openapi.yml` сервер выставлен на `http://localhost:8080`, чтобы совпадать с реальным `HTTP_ADDR` и корректно тестироваться через OpenAPI.
- **Поле в `/pullRequest/reassign`** — в исходном примере использовалось `old_reviewer_id`. Для соответствия коду и корректного JSON-декодинга изменил на `old_user_id`.
- **Admin token для `/users/setIsActive`** — в OpenAPI он присутствует, но в самом ТЗ никак не описан (нет требований, где брать токен, как его передавать и кого считать админом), поэтому я осознанно не реализовывал эту часть.
- **Пустые команды** — в ТЗ не было описано, что делать при создании команды без участников, поэтому я принял решение разрешить такой кейс: команда может быть создана с пустым списком участников (считаю это естественным сценарием).
- **Ограничение по командам** — в ТЗ не было указано, может ли один пользователь состоять в нескольких командах, поэтому я принял решение ограничить пользователя одной командой: при попытке добавить его в другую возвращается `VALIDATION_ERROR`. Это упрощает модель и делает выбор ревьюеров однозначным.
